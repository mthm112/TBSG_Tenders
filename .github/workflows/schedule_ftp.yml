name: Cleanup Inactive Assistants

on:
  schedule:
    # Run every hour at :00 minutes (e.g., 1:00, 2:00, 3:00)
    - cron: '0 * * * *'
  
  workflow_dispatch:
    inputs:
      inactivity_hours:
        description: 'Hours of inactivity before deletion'
        required: false
        default: '2'
      dry_run:
        description: 'Dry run (true/false) - show what would be deleted without deleting'
        required: false
        default: 'true'
      force:
        description: 'Force run even during business hours (true/false)'
        required: false
        default: 'false'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install pinecone requests python-dateutil
    
    - name: Check business hours
      id: check_hours
      run: |
        python << 'EOF'
        from datetime import datetime
        import os
        
        # Get current UTC time
        now = datetime.utcnow()
        
        # Convert to UK time (approximate - UTC+0 in winter, UTC+1 in summer)
        # For simplicity, we check UTC hour ranges that cover both GMT and BST
        # Business hours: 9am-5pm UK time
        # GMT (winter): 9am-5pm = 9:00-17:00 UTC
        # BST (summer): 9am-5pm = 8:00-16:00 UTC
        # Safe range: Skip cleanup between 8:00-17:00 UTC on weekdays
        
        is_weekday = now.weekday() < 5  # Monday=0, Friday=4
        is_business_hour = 7 <= now.hour < 18
        is_business_hours = is_weekday and is_business_hour
        
        force = "${{ github.event.inputs.force }}" == "true"
        
        if is_business_hours and not force:
            print(f"⚠️  BUSINESS HOURS DETECTED")
            print(f"Current time (UTC): {now.strftime('%A %H:%M')}")
            print(f"Day: {now.strftime('%A')} (weekday={is_weekday})")
            print(f"Hour: {now.hour} UTC (business hours: 8-17 UTC)")
            print(f"Cleanup will be skipped to protect active assistants")
            print(f"")
            print(f"To force cleanup during business hours, use:")
            print(f"  workflow_dispatch with force=true")
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write("SKIP=true\n")
        else:
            print(f"✓ Safe to run cleanup")
            print(f"Current time (UTC): {now.strftime('%A %H:%M')}")
            print(f"Weekday: {is_weekday}, Business hour: {is_business_hour}")
            if force:
                print(f"FORCED run during business hours")
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write("SKIP=false\n")
        EOF
    
    - name: Run cleanup script
      if: steps.check_hours.outputs.SKIP != 'true'
      env:
        PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        GITHUB_PERSONAL_ACCESS_TOKEN: ${{ secrets.GITHUB_PERSONAL_ACCESS_TOKEN }}
        GITHUB_OWNER: ${{ github.repository_owner }}
        GITHUB_REPO: ${{ github.event.repository.name }}
      run: |
        echo "Starting assistant cleanup..."
        echo "Inactivity threshold: ${{ github.event.inputs.inactivity_hours || '2' }} hours"
        echo "Dry run: ${{ github.event.inputs.dry_run || 'false' }}"
        echo "---"
        
        python assistant_cleanup.py \
          --hours ${{ github.event.inputs.inactivity_hours || '2' }} \
          ${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }}
    
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cleanup-logs-${{ github.run_number }}
        path: '*.log'
        retention-days: 30
